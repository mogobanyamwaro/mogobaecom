{"ast":null,"code":"import _regeneratorRuntime from\"/home/douglas/Downloads/ProShop/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/douglas/Downloads/ProShop/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import React,{Fragment,useEffect}from'react';import MetaData from'../layout/MetaData';import CheckoutSteps from'./CheckoutSteps';import{useAlert}from'react-alert';import{useDispatch,useSelector}from'react-redux';import{createOrder,clearErrors}from'../../actions/orderActions';import{emptyCart}from'../../actions/cartActions';import{useStripe,useElements,CardNumberElement,CardExpiryElement,CardCvcElement}from'@stripe/react-stripe-js';import axios from'axios';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var options={style:{base:{fontSize:'16px'},invalid:{color:'#9e2146'}}};var Payment=function Payment(_ref){var history=_ref.history;var alert=useAlert();var stripe=useStripe();var elements=useElements();var dispatch=useDispatch();var _useSelector=useSelector(function(state){return state.auth;}),user=_useSelector.user;var _useSelector2=useSelector(function(state){return state.cart;}),cartItems=_useSelector2.cartItems,shippingInfo=_useSelector2.shippingInfo;var _useSelector3=useSelector(function(state){return state.newOrder;}),error=_useSelector3.error;useEffect(function(){if(error){alert.error(error);dispatch(clearErrors());}},[dispatch,alert,error]);var order={orderItems:cartItems,shippingInfo:shippingInfo};var orderInfo=JSON.parse(sessionStorage.getItem('orderInfo'));if(orderInfo){order.itemsPrice=orderInfo.itemsPrice;order.shippingPrice=orderInfo.shippingPrice;order.taxPrice=orderInfo.taxPrice;order.totalPrice=orderInfo.totalPrice;}var paymentData={amount:Math.round(orderInfo.totalPrice*100)};var submitHandler=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var res,config,clientSecret,result;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:e.preventDefault();document.querySelector('#pay_btn').disabled=true;_context.prev=2;config={headers:{'Content-Type':'application/json'}};_context.next=6;return axios.post('/api/v1/payment/process',paymentData,config);case 6:res=_context.sent;clientSecret=res.data.client_secret;console.log(clientSecret);if(!(!stripe||!elements)){_context.next=11;break;}return _context.abrupt(\"return\");case 11:_context.next=13;return stripe.confirmCardPayment(clientSecret,{payment_method:{card:elements.getElement(CardNumberElement),billing_details:{name:user.name,email:user.email}}});case 13:result=_context.sent;if(result.error){alert.error(result.error.message);document.querySelector('#pay_btn').disabled=false;}else{// The payment is processed or not\nif(result.paymentIntent.status==='succeeded'){order.paymentInfo={id:result.paymentIntent.id,status:result.paymentIntent.status};dispatch(createOrder(order));dispatch(emptyCart());localStorage.removeItem('cartItems');history.push('/success');}else{alert.error('There is some issue while payment processing');}}_context.next=21;break;case 17:_context.prev=17;_context.t0=_context[\"catch\"](2);document.querySelector('#pay_btn').disabled=false;alert.error(_context.t0.response.data.message);case 21:case\"end\":return _context.stop();}}},_callee,null,[[2,17]]);}));return function submitHandler(_x){return _ref2.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(Fragment,{children:[/*#__PURE__*/_jsx(MetaData,{title:'Payment'}),/*#__PURE__*/_jsx(CheckoutSteps,{shipping:true,confirmOrder:true,payment:true}),/*#__PURE__*/_jsx(\"div\",{className:\"row wrapper\",children:/*#__PURE__*/_jsx(\"div\",{className:\"col-10 col-lg-5\",children:/*#__PURE__*/_jsxs(\"form\",{className:\"shadow-lg\",onSubmit:submitHandler,children:[/*#__PURE__*/_jsx(\"h1\",{className:\"mb-4\",children:\"Card Info\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_num_field\",children:\"Card Number\"}),/*#__PURE__*/_jsx(CardNumberElement,{type:\"text\",id:\"card_num_field\",className:\"form-control\",options:options})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_exp_field\",children:\"Card Expiry\"}),/*#__PURE__*/_jsx(CardExpiryElement,{type:\"text\",id:\"card_exp_field\",className:\"form-control\",options:options})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_cvc_field\",children:\"Card CVC\"}),/*#__PURE__*/_jsx(CardCvcElement,{type:\"text\",id:\"card_cvc_field\",className:\"form-control\",options:options})]}),/*#__PURE__*/_jsxs(\"button\",{id:\"pay_btn\",type:\"submit\",className:\"btn btn-block py-3\",children:[\"Pay \",\" - \".concat(orderInfo&&orderInfo.totalPrice)]})]})})})]});};export default Payment;","map":{"version":3,"sources":["/home/douglas/Downloads/ProShop/frontend/src/components/cart/Payment.js"],"names":["React","Fragment","useEffect","MetaData","CheckoutSteps","useAlert","useDispatch","useSelector","createOrder","clearErrors","emptyCart","useStripe","useElements","CardNumberElement","CardExpiryElement","CardCvcElement","axios","options","style","base","fontSize","invalid","color","Payment","history","alert","stripe","elements","dispatch","state","auth","user","cart","cartItems","shippingInfo","newOrder","error","order","orderItems","orderInfo","JSON","parse","sessionStorage","getItem","itemsPrice","shippingPrice","taxPrice","totalPrice","paymentData","amount","Math","round","submitHandler","e","preventDefault","document","querySelector","disabled","config","headers","post","res","clientSecret","data","client_secret","console","log","confirmCardPayment","payment_method","card","getElement","billing_details","name","email","result","message","paymentIntent","status","paymentInfo","id","localStorage","removeItem","push","response"],"mappings":"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","sourcesContent":["import React, { Fragment, useEffect } from 'react';\n\nimport MetaData from '../layout/MetaData';\nimport CheckoutSteps from './CheckoutSteps';\n\nimport { useAlert } from 'react-alert';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { createOrder, clearErrors } from '../../actions/orderActions';\nimport { emptyCart } from '../../actions/cartActions';\n\nimport {\n  useStripe,\n  useElements,\n  CardNumberElement,\n  CardExpiryElement,\n  CardCvcElement,\n} from '@stripe/react-stripe-js';\n\nimport axios from 'axios';\n\nconst options = {\n  style: {\n    base: {\n      fontSize: '16px',\n    },\n    invalid: {\n      color: '#9e2146',\n    },\n  },\n};\n\nconst Payment = ({ history }) => {\n  const alert = useAlert();\n  const stripe = useStripe();\n  const elements = useElements();\n  const dispatch = useDispatch();\n\n  const { user } = useSelector((state) => state.auth);\n  const { cartItems, shippingInfo } = useSelector((state) => state.cart);\n  const { error } = useSelector((state) => state.newOrder);\n\n  useEffect(() => {\n    if (error) {\n      alert.error(error);\n      dispatch(clearErrors());\n    }\n  }, [dispatch, alert, error]);\n\n  const order = {\n    orderItems: cartItems,\n    shippingInfo,\n  };\n\n  const orderInfo = JSON.parse(sessionStorage.getItem('orderInfo'));\n  if (orderInfo) {\n    order.itemsPrice = orderInfo.itemsPrice;\n    order.shippingPrice = orderInfo.shippingPrice;\n    order.taxPrice = orderInfo.taxPrice;\n    order.totalPrice = orderInfo.totalPrice;\n  }\n\n  const paymentData = {\n    amount: Math.round(orderInfo.totalPrice * 100),\n  };\n\n  const submitHandler = async (e) => {\n    e.preventDefault();\n\n    document.querySelector('#pay_btn').disabled = true;\n\n    let res;\n    try {\n      const config = {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      };\n\n      res = await axios.post('/api/v1/payment/process', paymentData, config);\n\n      const clientSecret = res.data.client_secret;\n\n      console.log(clientSecret);\n\n      if (!stripe || !elements) {\n        return;\n      }\n\n      const result = await stripe.confirmCardPayment(clientSecret, {\n        payment_method: {\n          card: elements.getElement(CardNumberElement),\n          billing_details: {\n            name: user.name,\n            email: user.email,\n          },\n        },\n      });\n\n      if (result.error) {\n        alert.error(result.error.message);\n        document.querySelector('#pay_btn').disabled = false;\n      } else {\n        // The payment is processed or not\n        if (result.paymentIntent.status === 'succeeded') {\n          order.paymentInfo = {\n            id: result.paymentIntent.id,\n            status: result.paymentIntent.status,\n          };\n\n          dispatch(createOrder(order));\n          dispatch(emptyCart());\n          localStorage.removeItem('cartItems');\n\n          history.push('/success');\n        } else {\n          alert.error('There is some issue while payment processing');\n        }\n      }\n    } catch (error) {\n      document.querySelector('#pay_btn').disabled = false;\n      alert.error(error.response.data.message);\n    }\n  };\n\n  return (\n    <Fragment>\n      <MetaData title={'Payment'} />\n\n      <CheckoutSteps shipping confirmOrder payment />\n\n      <div className='row wrapper'>\n        <div className='col-10 col-lg-5'>\n          <form className='shadow-lg' onSubmit={submitHandler}>\n            <h1 className='mb-4'>Card Info</h1>\n            <div className='form-group'>\n              <label htmlFor='card_num_field'>Card Number</label>\n              <CardNumberElement\n                type='text'\n                id='card_num_field'\n                className='form-control'\n                options={options}\n              />\n            </div>\n\n            <div className='form-group'>\n              <label htmlFor='card_exp_field'>Card Expiry</label>\n              <CardExpiryElement\n                type='text'\n                id='card_exp_field'\n                className='form-control'\n                options={options}\n              />\n            </div>\n\n            <div className='form-group'>\n              <label htmlFor='card_cvc_field'>Card CVC</label>\n              <CardCvcElement\n                type='text'\n                id='card_cvc_field'\n                className='form-control'\n                options={options}\n              />\n            </div>\n\n            <button id='pay_btn' type='submit' className='btn btn-block py-3'>\n              Pay {` - ${orderInfo && orderInfo.totalPrice}`}\n            </button>\n          </form>\n        </div>\n      </div>\n    </Fragment>\n  );\n};\n\nexport default Payment;\n"]},"metadata":{},"sourceType":"module"}